<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>投資組合儀表板</title>
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0f172a;
        --panel: #1e293b;
        --text: #e2e8f0;
        --muted: #94a3b8;
        --accent: #38bdf8;
        --positive: #22c55e;
        --negative: #f43f5e;
      }
      body {
        margin: 0;
        font-family: "Noto Sans TC", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem 3rem;
      }
      header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
      }
      header h1 {
        font-size: 1.8rem;
        margin: 0;
      }
      .summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        margin: 2rem 0;
      }
      .card {
        background: var(--panel);
        border-radius: 0.75rem;
        padding: 1.25rem;
        box-shadow: 0 10px 25px rgb(15 23 42 / 60%);
      }
      .card h3 {
        margin: 0 0 0.5rem;
        font-size: 0.95rem;
        color: var(--muted);
        letter-spacing: 0.05em;
      }
      .card p {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 600;
      }
      .daily-return.positive {
        color: var(--positive);
      }
      .daily-return.negative {
        color: var(--negative);
      }
      .chart-panel {
        background: var(--panel);
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 25px rgb(15 23 42 / 60%);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: var(--panel);
        border-radius: 0.75rem;
        overflow: hidden;
      }
      th,
      td {
        padding: 0.85rem;
        text-align: right;
      }
      th {
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        color: var(--muted);
        background: rgb(255 255 255 / 4%);
      }
      td:first-child,
      th:first-child {
        text-align: left;
      }
      tbody tr:nth-child(even) {
        background: rgb(255 255 255 / 2%);
      }
      tbody tr:not(:last-child) {
        border-bottom: 1px solid rgb(255 255 255 / 6%);
      }
      .sources {
        color: var(--muted);
        font-size: 0.9rem;
        margin-top: 0.5rem;
      }
      @media (max-width: 640px) {
        th,
        td {
          font-size: 0.85rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>投資組合儀表板</h1>
        <div class="sources">資料日期：{{ record_date }} ｜ {{ price_sources }}</div>
      </header>

      <section class="summary">
        <div class="card">
          <h3>Total USD</h3>
          <p>${{ "%.2f"|format(summary.total_usd) }}</p>
        </div>
        <div class="card">
          <h3>Total TWD</h3>
          <p>NT${{ "%.2f"|format(summary.total_twd) }}</p>
        </div>
        <div class="card">
          <h3>Daily Return</h3>
          <p
            class="daily-return {{ 'positive' if summary.daily_return_pct >= 0 else 'negative' }}"
          >
            {{ "%.2f"|format(summary.daily_return_pct) }}%
          </p>
        </div>
      </section>

      <section class="chart-panel">
        <canvas id="historyChart" width="400" height="160"></canvas>
      </section>

      <section>
        <table>
          <thead>
            <tr>
              <th>標的/貨幣</th>
              <th>類型</th>
              <th>數量</th>
              <th>單價</th>
              <th>幣別</th>
              <th>價值(USD)</th>
              <th>價值(TWD)</th>
              <th>佔比%</th>
            </tr>
          </thead>
          <tbody>
            {% for pos in result.positions %}
            <tr>
              <td>{{ pos.name }}</td>
              <td>{{ pos.category }}</td>
              <td>{{ "%.4f"|format(pos.quantity) if pos.quantity is not none else "-" }}</td>
              <td>
                {% if pos.unit_price is not none %}
                  {{ "%.4f"|format(pos.unit_price) }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>{{ pos.price_currency or "-" }}</td>
              <td>${{ "{:,.2f}".format(pos.value_usd) }}</td>
              <td>NT${{ "{:,.2f}".format(pos.value_twd) }}</td>
              <td>{{ "%.2f"|format(pos.portfolio_pct) }}%</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>
    </div>

    <script>
      const labels = {{ history_labels | tojson }};
      const totals = {{ history_totals | tojson }};
      const returns = {{ history_returns | tojson }};

      const ctx = document.getElementById("historyChart");
      new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "總資產 (USD)",
              data: totals,
              borderColor: "#38bdf8",
              backgroundColor: "rgba(56, 189, 248, 0.15)",
              tension: 0.25,
              fill: true,
              yAxisID: "y",
            },
            {
              label: "每日報酬率 (%)",
              data: returns,
              borderColor: "#f97316",
              backgroundColor: "rgba(249, 115, 22, 0.25)",
              tension: 0.3,
              fill: false,
              yAxisID: "y1",
            },
          ],
        },
        options: {
          responsive: true,
          interaction: {
            intersect: false,
            mode: "index",
          },
          stacked: false,
          plugins: {
            legend: {
              labels: {
                color: "#e2e8f0",
              },
            },
          },
          scales: {
            y: {
              type: "linear",
              display: true,
              position: "left",
              grid: {
                color: "rgba(148, 163, 184, 0.2)",
              },
              ticks: {
                color: "#e2e8f0",
              },
            },
            y1: {
              type: "linear",
              display: true,
              position: "right",
              grid: {
                drawOnChartArea: false,
              },
              ticks: {
                color: "#e2e8f0",
              },
            },
            x: {
              ticks: {
                color: "#e2e8f0",
              },
            },
          },
        },
      });
    </script>
  </body>
</html>
